<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:activiti="http://activiti.org/bpmn"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
             targetNamespace="http://activiti.org/content-system">

    <message id="MSG_INDEX_SYNC_V2" name="INDEX_SYNC_MESSAGE_V2" />
    <message id="MSG_PUSH_V2" name="SEND_PUSH_MSG_V2" />

    <collaboration id="collab-content-system">
        <participant id="part-content" name="Content Publish Service" processRef="content-publish-process-v2" />
        <participant id="part-index" name="Search Sync Service" processRef="index-sync-process-v2" />
        <participant id="part-push" name="Message Push Service" processRef="push-process-v2" />
        
        <!-- 消息流：从 Publish Content 节点触发子流程消息 -->
        <messageFlow id="msg-flow-index" name="Sync Search Index" sourceRef="publishTask" targetRef="start-index" />
        <messageFlow id="msg-flow-push" name="Send Notification" sourceRef="publishTask" targetRef="start-push" />
    </collaboration>

    <process id="content-publish-process-v2" name="Content Publish Process" isExecutable="true">
        <startEvent id="startEvent" name="Start" />
        <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="autoReviewTask" />
        <serviceTask id="autoReviewTask" name="Automated Content Review" activiti:delegateExpression="${contentReviewDelegate}" />
        <sequenceFlow id="flow2" sourceRef="autoReviewTask" targetRef="reviewGateway" />
        <exclusiveGateway id="reviewGateway" name="Review Result" />
        <sequenceFlow id="flowApproved" name="Approved" sourceRef="reviewGateway" targetRef="publishTask">
            <conditionExpression xsi:type="tFormalExpression">${autoCheckPassed == true}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow id="flowRejected" name="Rejected" sourceRef="reviewGateway" targetRef="endEventRejected">
             <conditionExpression xsi:type="tFormalExpression">${autoCheckPassed == false}</conditionExpression>
        </sequenceFlow>
        <serviceTask id="publishTask" name="Publish Content" activiti:delegateExpression="${contentPublishDelegate}" />
        <sequenceFlow id="flow4" sourceRef="publishTask" targetRef="endEventPublished" />
        <endEvent id="endEventPublished" name="Published" />
        <endEvent id="endEventRejected" name="Review Failed" />
    </process>

    <process id="content-index-sync-process-v2" name="Content Index Process" isExecutable="true">
        <startEvent id="start-index" name="Index Sync Trigger">
            <messageEventDefinition messageRef="MSG_INDEX_SYNC_V2" />
        </startEvent>
        <parallelGateway id="gw-index-split" />
        <serviceTask id="task-es-index" name="Update ES Index" activiti:delegateExpression="${persistenceDelegate}" />
        <serviceTask id="task-trigger-collect" name="Log Sync Event" activiti:delegateExpression="${triggerCollectionDelegate}" />
        <parallelGateway id="gw-index-join" />
        <endEvent id="end-index" />
        <sequenceFlow id="idx1" sourceRef="start-index" targetRef="gw-index-split" />
        <sequenceFlow id="idx2" sourceRef="gw-index-split" targetRef="task-es-index" />
        <sequenceFlow id="idx3" sourceRef="gw-index-split" targetRef="task-trigger-collect" />
        <sequenceFlow id="idx4" sourceRef="task-es-index" targetRef="gw-index-join" />
        <sequenceFlow id="idx5" sourceRef="task-trigger-collect" targetRef="gw-index-join" />
        <sequenceFlow id="idx6" sourceRef="gw-index-join" targetRef="end-index" />
    </process>

    <process id="content-push-process-v2" name="Content Push Process" isExecutable="true">
        <startEvent id="start-push" name="Push Trigger">
            <messageEventDefinition messageRef="MSG_PUSH_V2" />
        </startEvent>
        <serviceTask id="task-push-logic" name="Execute Push" activiti:delegateExpression="${pushDelegate}" />
        <endEvent id="end-push" />
        <sequenceFlow id="p1" sourceRef="start-push" targetRef="task-push-logic" />
        <sequenceFlow id="p2" sourceRef="task-push-logic" targetRef="end-push" />
    </process>

    <bpmndi:BPMNDiagram id="BPMNDiagram_collab-content-system">
        <bpmndi:BPMNPlane bpmnElement="collab-content-system" id="BPMNPlane_collab-content-system">
            
            <!-- Content Pool -->
            <bpmndi:BPMNShape bpmnElement="part-content" id="BPMNShape_part-content" isHorizontal="true">
                <omgdc:Bounds height="350.0" width="1000.0" x="50.0" y="50.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="startEvent" id="BPMNShape_startEvent">
                <omgdc:Bounds height="35.0" width="35.0" x="100.0" y="200.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="autoReviewTask" id="BPMNShape_autoReviewTask">
                <omgdc:Bounds height="60.0" width="100.0" x="180.0" y="187.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="reviewGateway" id="BPMNShape_reviewGateway" isMarkerVisible="true">
                <omgdc:Bounds height="40.0" width="40.0" x="320.0" y="197.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="publishTask" id="BPMNShape_publishTask">
                <omgdc:Bounds height="60.0" width="100.0" x="450.0" y="187.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="endEventPublished" id="BPMNShape_endEventPublished">
                <omgdc:Bounds height="35.0" width="35.0" x="650.0" y="200.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="endEventRejected" id="BPMNShape_endEventRejected">
                <omgdc:Bounds height="35.0" width="35.0" x="450.0" y="300.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNEdge bpmnElement="flow1" id="BPMNEdge_flow1">
                <omgdi:waypoint x="135.0" y="217.5"/>
                <omgdi:waypoint x="180.0" y="217.0"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge bpmnElement="flow2" id="BPMNEdge_flow2">
                <omgdi:waypoint x="280.0" y="217.0"/>
                <omgdi:waypoint x="320.0" y="217.0"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge bpmnElement="flowApproved" id="BPMNEdge_flowApproved">
                <omgdi:waypoint x="360.0" y="217.0"/>
                <omgdi:waypoint x="450.0" y="217.0"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge bpmnElement="flowRejected" id="BPMNEdge_flowRejected">
                <omgdi:waypoint x="340.0" y="237.0"/>
                <omgdi:waypoint x="340.0" y="317.0"/>
                <omgdi:waypoint x="450.0" y="317.5"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge bpmnElement="flow4" id="BPMNEdge_flow4">
                <omgdi:waypoint x="550.0" y="217.0"/>
                <omgdi:waypoint x="650.0" y="217.5"/>
            </bpmndi:BPMNEdge>

            <!-- Index Pool -->
            <bpmndi:BPMNShape bpmnElement="part-index" id="BPMNShape_part-index" isHorizontal="true">
                <omgdc:Bounds height="250.0" width="1000.0" x="50.0" y="450.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="start-index" id="BPMNShape_start-index">
                <omgdc:Bounds height="35.0" width="35.0" x="117.5" y="550.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="gw-index-split" id="BPMNShape_gw-index-split">
                <omgdc:Bounds height="40.0" width="40.0" x="200.0" y="547.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="task-es-index" id="BPMNShape_task-es-index">
                <omgdc:Bounds height="60.0" width="100.0" x="300.0" y="480.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="task-trigger-collect" id="BPMNShape_task-trigger-collect">
                <omgdc:Bounds height="60.0" width="100.0" x="300.0" y="600.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="gw-index-join" id="BPMNShape_gw-index-join">
                <omgdc:Bounds height="40.0" width="40.0" x="450.0" y="547.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="end-index" id="BPMNShape_end-index">
                <omgdc:Bounds height="35.0" width="35.0" x="550.0" y="550.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNEdge bpmnElement="idx1" id="BPMNEdge_idx1">
                <omgdi:waypoint x="152.5" y="567.5"/>
                <omgdi:waypoint x="200.0" y="567.0"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge bpmnElement="idx2" id="BPMNEdge_idx2">
                <omgdi:waypoint x="240.0" y="567.0"/>
                <omgdi:waypoint x="240.0" y="510.0"/>
                <omgdi:waypoint x="300.0" y="510.0"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge bpmnElement="idx3" id="BPMNEdge_idx3">
                <omgdi:waypoint x="240.0" y="567.0"/>
                <omgdi:waypoint x="240.0" y="630.0"/>
                <omgdi:waypoint x="300.0" y="630.0"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge bpmnElement="idx4" id="BPMNEdge_idx4">
                <omgdi:waypoint x="400.0" y="510.0"/>
                <omgdi:waypoint x="470.0" y="510.0"/>
                <omgdi:waypoint x="470.0" y="547.0"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge bpmnElement="idx5" id="BPMNEdge_idx5">
                <omgdi:waypoint x="400.0" y="630.0"/>
                <omgdi:waypoint x="470.0" y="630.0"/>
                <omgdi:waypoint x="470.0" y="587.0"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge bpmnElement="idx6" id="BPMNEdge_idx6">
                <omgdi:waypoint x="490.0" y="567.0"/>
                <omgdi:waypoint x="550.0" y="567.5"/>
            </bpmndi:BPMNEdge>

            <!-- Push Pool -->
            <bpmndi:BPMNShape bpmnElement="part-push" id="BPMNShape_part-push" isHorizontal="true">
                <omgdc:Bounds height="150.0" width="1000.0" x="50.0" y="750.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="start-push" id="BPMNShape_start-push">
                <omgdc:Bounds height="35.0" width="35.0" x="117.5" y="810.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="task-push-logic" id="BPMNShape_task-push-logic">
                <omgdc:Bounds height="60.0" width="100.0" x="220.0" y="797.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape bpmnElement="end-push" id="BPMNShape_end-push">
                <omgdc:Bounds height="35.0" width="35.0" x="380.0" y="810.0"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNEdge bpmnElement="p1" id="BPMNEdge_p1">
                <omgdi:waypoint x="152.5" y="827.5"/>
                <omgdi:waypoint x="220.0" y="827.0"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge bpmnElement="p2" id="BPMNEdge_p2">
                <omgdi:waypoint x="320.0" y="827.0"/>
                <omgdi:waypoint x="380.0" y="827.5"/>
            </bpmndi:BPMNEdge>

            <!-- 消息流 (跨池虚线交互) -->
            <bpmndi:BPMNEdge bpmnElement="msg-flow-index" id="BPMNEdge_msg-flow-index">
                <omgdi:waypoint x="500.0" y="247.0"/>
                <omgdi:waypoint x="500.0" y="380.0"/>
                <omgdi:waypoint x="117.5" y="380.0"/>
                <omgdi:waypoint x="117.5" y="550.0"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge bpmnElement="msg-flow-push" id="BPMNEdge_msg-flow-push">
                <omgdi:waypoint x="520.0" y="247.0"/>
                <omgdi:waypoint x="520.0" y="700.0"/>
                <omgdi:waypoint x="117.5" y="700.0"/>
                <omgdi:waypoint x="117.5" y="810.0"/>
            </bpmndi:BPMNEdge>
        </bpmndi:BPMNPlane>
    </bpmndi:BPMNDiagram>
</definitions>
