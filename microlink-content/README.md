# Content Management Microservice (microlink-content)

This module handles content publishing, storage (S3), and review workflow (Activiti).

## 1. Prerequisites & Installation

### Prerequisites
*   **Java 21**
*   **Maven**
*   **Docker** (for MySQL)

### Setup Database
Start a MySQL container using the project's compose file or manually:
```bash
# In project root
docker compose up -d mysql
```
Ensure the database `mydatabase` exists.

### Configuration
Update `src/main/resources/application.properties` with your AWS keys and S3 path if needed:
```properties
aws.s3.accessKey=YOUR_ACCESS_KEY
aws.s3.secretKey=YOUR_SECRET_KEY
aws.s3.region=us-east-1
# Configure the full S3 path (Bucket + Prefix)
aws.s3.path=s3://home-dongyang/microlink/
```

### Build & Run
```bash
cd microlink-content
mvn clean install
mvn spring-boot:run
```
The service will start on port **8082**.

## 2. Integration Details

### Spring Cloud / REST API
The service follows RESTful standards. All endpoints are prefixed with `/api/content`.
*   **Upload**: `/api/content/upload` (Multipart file -> JSON metadata)
*   **Publish**: `/api/content/publish` (JSON)
*   **List**: `/api/content/list` (Pagination)
*   **Update**: `/api/content/update/{id}`
*   **Delete**: `/api/content/{id}`
*   **Review**: `/api/content/review/*`

### Activiti Workflow
We use **Activiti 7** to manage the content review process.
*   **Definition**: `src/main/resources/processes/content-review.bpmn20.xml`
*   **Logic**:
    1.  User publishes content -> Status: `PENDING`
    2.  Process starts -> Task assigned to `admin` group
    3.  Admin reviews -> Status updates to `PUBLISHED` or `REJECTED`

### S3 Storage
Files are stored in AWS S3 using the configured `aws.s3.path`.
*   The system parses the URI (e.g., `s3://bucket/folder/`) to determine the bucket and directory.
*   Files are named with a UUID prefix to prevent collisions.

## 3. Step-by-Step Verification Guide

Follow these steps to verify functionalities. Note that you need a valid JWT token, which is generated by the **User Service** (`microlink-user`).

### Step 0: Obtain Token (User Service)
Ensure `microlink-user` is running on port **8081**.
1.  **Register/Login** to get the token.
    ```bash
    curl -X POST http://localhost:8081/api/user/auth/login \
      -H "Content-Type: application/json" \
      -d '{"username": "testuser", "password": "password"}'
    ```
    *(If the user doesn't exist, use `/register` first)*

2.  **Copy the `accessToken`** from the response. You will use this as `<YOUR_TOKEN>` or `<ADMIN_TOKEN>` (if the user has admin role).

### Step 1: Upload Media (Recommended)
Upload images or videos first to get their IDs.
```bash
curl -X POST http://localhost:8082/api/content/upload \
  -H "Authorization: Bearer <YOUR_TOKEN>" \
  -F "file=@/path/to/image.jpg"
```
*Expected Output*: Media object with `id`, `url`, `width`, `height`. Note the `id` (e.g., `101`).

### Step 2: Publish Content
Send a JSON request to publish content using the Media IDs.

**1. Publish a Post (Short Content)**
```bash
curl -X POST http://localhost:8082/api/content/publish \
  -H "Authorization: Bearer <YOUR_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "content": "Just a quick update!",
    "contentType": "POST",
    "mediaIds": [101]
  }'
```

**2. Publish an Article**
```bash
curl -X POST http://localhost:8082/api/content/publish \
  -H "Authorization: Bearer <YOUR_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "My First Article",
    "content": "This is the detailed content...",
    "contentType": "ARTICLE",
    "summary": "Short summary...",
    "coverId": 101
  }'
```

**3. Publish a Video**
```bash
curl -X POST http://localhost:8082/api/content/publish \
  -H "Authorization: Bearer <YOUR_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "My Vlog",
    "content": "Check out this video!",
    "contentType": "VIDEO",
    "mainMediaId": 102,
    "coverId": 101
  }'
```

*Expected Output*: Content object with `status: "PENDING"`.

### Step 3: List Content
```bash
curl -X GET "http://localhost:8082/api/content/list?page=0&size=10&status=PUBLISHED" \
  -H "Authorization: Bearer <YOUR_TOKEN>"
```
*Expected Output*: Paginated list of content items with Author info.

### Step 4: Review Content (Admin)

**1. Get Review Tasks**
```bash
curl -X GET http://localhost:8082/api/content/review/tasks \
  -H "Authorization: Bearer <ADMIN_TOKEN>"
```
*Expected Output*: List of tasks (e.g., "Review Content"). **Copy the Task ID.**

**2. Approve Content**
```bash
curl -X POST http://localhost:8082/api/content/review/tasks/<TASK_ID> \
  -H "Authorization: Bearer <ADMIN_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"approved": true}'
```
*Expected Output*: `{"message":"Review completed"}`. Content status should now be `PUBLISHED`.

## 4. Running Tests
To verify the code integrity:
```bash
mvn test
```
